apiVersion: 1

groups:
  - name: AppAlerts
    folder: 'Application Alerts'
    interval: 20s

    rules:
      - alert: HighAPILatency
        uid: highapilatency01
        title: "ðŸš¨ p99 Latency /api/login > 0.5s"
        for: 0s
        noDataState: OK
        executionErrorState: OK

        labels:
          severity: critical
          alertname: HighAPILatency
          grafana_org_id: "1"

        annotations:
          summary: "p99 /api/login = {{ $values.B | printf \"%.2f\" }}s (>0.5s)"
          description: |
            **Service:** API Gateway  
            **Endpoint:** `/api/login`  
            **Current p99:** {{ $values.B | printf \"%.2f\" }}s  
            **Threshold:** 0.5s  

        # ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð½Ð° ÑˆÐ°Ð³ C, Ð³Ð´Ðµ ÑƒÐ¶Ðµ true/false
        condition: C

        data:
          # Ð¨Ð°Ð³ A: ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ p99 (Ð¸Ð»Ð¸ 0, ÐµÑÐ»Ð¸ ÑÐ¾Ð²ÑÐµÐ¼ Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…)
          - refId: A
            datasourceUid: prometheus
            model:
              expr: |
                histogram_quantile(0.99,
                  sum by (le) (
                    rate(http_request_latency_seconds_bucket{endpoint="/api/login",method="POST"}[1m])
                  )
                )
                or vector(0)
            interval: "20s"
            datasource:
              type: prometheus
              uid: prometheus
            relativeTimeRange:
              from: 60
              to:   0

          # Ð¨Ð°Ð³ B: ÑÐ²Ð¾Ð´Ð¸Ð¼ Ð²ÐµÐºÑ‚Ð¾Ñ€ A Ðº Ð¾Ð´Ð½Ð¾Ð¼Ñƒ Ñ‡Ð¸ÑÐ»Ñƒ â€” Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼Ñƒ
          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: A
              defaultValue: 0

          # Ð¨Ð°Ð³ C: Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑˆÐ°Ð³, Ð´Ð°ÑŽÑ‰Ð¸Ð¹ Ð±ÑƒÐ»ÐµÐ²Ð¾ true/false
          - refId: C
            datasourceUid: __expr__
            model:
              type: math
              expression: "$B > 0.5"


      - alert: HighDatabaseRPS
        uid: highdbrps01
        title: "ðŸš¨ DB RPS > 100"
        for: 0s
        noDataState: OK
        executionErrorState: OK

        labels:
          severity: warning
          alertname: HighDatabaseRPS
          grafana_org_id: "1"

        annotations:
          summary: "DB RPS = {{ $values.B | printf \"%.0f\" }} (>100)"
          description: |
            **Service:** PostgreSQL  
            **Metric:** commits+rollbacks per second  
            **Current RPS:** {{ $values.B | printf "%.0f" }}  
            **Threshold:** 100 RPS  

        condition: C

        data:
          # Ð¨Ð°Ð³ A: ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ RPS
          - refId: A
            datasourceUid: prometheus
            model:
              expr: |
                sum(
                  rate(pg_transactions_total_commits[1m]) +
                  rate(pg_transactions_total_rollbacks[1m])
                )
            interval: "20s"
            datasource:
              type: prometheus
              uid: prometheus
            relativeTimeRange:
              from: 60
              to:   0

          # Ð¨Ð°Ð³ B: Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ value Ð¸Ð· A
          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: A
              defaultValue: 0

          # Ð¨Ð°Ð³ C: Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
          - refId: C
            datasourceUid: __expr__
            model:
              type: math
              expression: "$B > 100"
